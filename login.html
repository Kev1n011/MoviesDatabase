<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/simple-line-icons/2.4.1/css/simple-line-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="/Style/login.css">
</head>

<body>
    <div id="main">
        <div class="login-wrap">
            <div class="login-html">
                
                <input id="tab-1" type="radio" name="tab" class="sign-in" checked><label for="tab-1" class="tab">Iniciar sesión</label>
                
                <input id="tab-2" type="radio" name="tab" class="sign-up"><label for="tab-2" class="tab"></label>
                
                <div class="login-form">
                    <div class="sign-in-htm">
                        <div class="indicaciones">
                            <p>Ingresa tu usuario y contraseña existentes</p>

                        </div>
                        
                        <div class="group">
                            <label for="username" class="label">Usuario</label>
                            <input v-model="usuario.username" id="username" type="text" class="input">
                        </div>
                        <div class="group">
                            <label for="pass" class="label">Contraseña</label>
                            <input v-model="usuario.contrasena" id="pass" type="password" class="input" data-type="password">
                        </div>
                        <div class="group">
                            <button @click="validarFormulario" class="button">Acceder</button>
                        </div>
                        <div class="hr"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        const { createApp, ref } = Vue;

        createApp({
            setup() {
                const usuario = ref({
                    username: '',
                    contrasena: ''
                });

                return {
                    usuario
                };
            },
            methods: {
                //Obtener token para iniciar sesión
                async obtenerToken() {
                    if (!this.usuario.username || !this.usuario.contrasena) {
                        alert("Por favor, ingresa el usuario y la contraseña.");
                        return;
                    }

                    try {
                        const myHeaders = new Headers();
                        myHeaders.append("Authorization", "Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI4MTg5N2M2Mjk0MzE5YmZjMDZjMzliYTc0MGE2YmZhYiIsIm5iZiI6MTcyODU2NTQzMC42NjU0NjEsInN1YiI6IjY2ZjNmOTk3M2E5NWE1YmNkYTIyZmExNCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.-7B-PHciEuOMKZXeB8SwBdjvE4o3chMrKTqFWlu0i1c");

                        const requestOptions = {
                            method: 'GET',
                            headers: myHeaders,
                            redirect: 'follow'
                        };

                        const response = await fetch("https://api.themoviedb.org/3/authentication/token/new", requestOptions);
                        const result = await response.json();

                        if (result.success) {
                            const token = result.request_token;
                            localStorage.setItem('token', token);

                            // Validar las credenciales del usuario
                            this.validarCredenciales(token);
                        } else {
                            console.error("Error al obtener el token:", result);
                        }
                    } catch (error) {
                        console.error('Error:', error);
                    }
                },

                // Validar credenciales con el token
                async validarCredenciales(token) {
                    try {
                        const myHeaders = new Headers();
                        myHeaders.append("Content-Type", "application/json");
                        myHeaders.append("Authorization", "Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI4MTg5N2M2Mjk0MzE5YmZjMDZjMzliYTc0MGE2YmZhYiIsIm5iZiI6MTcyODU2NTQzMC42NjU0NjEsInN1YiI6IjY2ZjNmOTk3M2E5NWE1YmNkYTIyZmExNCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.-7B-PHciEuOMKZXeB8SwBdjvE4o3chMrKTqFWlu0i1c");

                        const raw = JSON.stringify({
                            "username": this.usuario.username,
                            "password": this.usuario.contrasena,
                            "request_token": token
                        });

                        const requestOptions = {
                            method: 'POST',
                            headers: myHeaders,
                            body: raw,
                            redirect: 'follow'
                        };

                        const response = await fetch("https://api.themoviedb.org/3/authentication/token/validate_with_login", requestOptions);
                        const result = await response.json();

                        if (result.success) {
                            // Si es válido, crear la sesión
                            this.generarSessionID(token);
                        } else {
                            alert("Usuario o contraseña incorrectos.");
                        }
                    } catch (error) {
                        console.error('Error al validar las credenciales:', error);
                    }
                },

                // Crear la session ID después de la validación del token
                async generarSessionID(token) {
                    try {
                        const myHeaders = new Headers();
                        myHeaders.append("Content-Type", "application/json");
                        myHeaders.append("Authorization", "Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI4MTg5N2M2Mjk0MzE5YmZjMDZjMzliYTc0MGE2YmZhYiIsIm5iZiI6MTcyODU2NTQzMC42NjU0NjEsInN1YiI6IjY2ZjNmOTk3M2E5NWE1YmNkYTIyZmExNCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.-7B-PHciEuOMKZXeB8SwBdjvE4o3chMrKTqFWlu0i1c");

                        const raw = JSON.stringify({
                            "request_token": token
                        });

                        const requestOptions = {
                            method: 'POST',
                            headers: myHeaders,
                            body: raw,
                            redirect: 'follow'
                        };

                        const response = await fetch("https://api.themoviedb.org/3/authentication/session/new?api_key=81897c6294319bfc06c39ba740a6bfab", requestOptions);
                        const result = await response.json();

                        if (result.success) {
                            alert("Sesión creada exitosamente");
                            localStorage.setItem('session_id', result.session_id);
                            window.location.href = './movies.html';
                        } else {
                            alert("Error al crear la sesión.");
                        }
                    } catch (error) {
                        console.error('Error al crear la sesión:', error);
                    }
                },

                validarFormulario() {
                    this.obtenerToken();
                }
            },
        }).mount('#main');
    </script>

    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.15/jquery.mask.min.js"></script>

</body>

</html>
